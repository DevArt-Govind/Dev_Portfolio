import { fromEvent } from 'rxjs';
export class SplitNodes {
    constructor(textContent, el, options) {
        this.textContent = textContent;
        this.el = el;
        this.options = options;
        this.words = [];
        this.chars = [];
        this.lineWords = [];
        this.lineChars = [];
        this.wordsArray = [];
        this.nodes = [];
        this.nodeTypes = {
            ELEMENT_NODE: 1,
            ATTRIBUTE_NODE: 2,
            TEXT_NODE: 3,
            CDATA_SECTION_NODE: 4,
            ENTITY_REFERENCE_NODE: 5,
            ENTITY_NODE: 6,
            PROCESSING_INSTRUCTION_NODE: 7,
            COMMENT_NODE: 8,
            DOCUMENT_NODE: 9,
            DOCUMENT_TYPE_NODE: 10,
            DOCUMENT_FRAGMENT_NODE: 11,
            NOTATION_NODE: 12
        };
    }
    initSplitNodes() {
        this.splitNodes(this.el);
        this.initNewNodes();
        this.setLines();
        this.updateOnResize();
    }
    splitNodes(el) {
        for (let i = 0; i < el.childNodes.length; i++) {
            const node = el.childNodes[i];
            const tag = [this.nodeTypes.ELEMENT_NODE, this.nodeTypes.DOCUMENT_NODE, this.nodeTypes.DOCUMENT_FRAGMENT_NODE].indexOf(node.nodeType) !== -1;
            const text = [this.nodeTypes.TEXT_NODE, this.nodeTypes.CDATA_SECTION_NODE].indexOf(node.nodeType) !== -1;
            if (tag) {
                this.splitNodes(node);
            }
            else if (text) {
                const words = this.splitNodesIntoWords(node);
                const wordsArray = [];
                words.forEach(chars => {
                    const wordSpan = document.createElement('span');
                    wordSpan.classList.add('split-text-word');
                    wordSpan.style.display = 'inline-block';
                    wordSpan.style.textIndent = '0';
                    if (this.options.onlyWords) {
                        wordSpan.innerHTML = chars.join('');
                    }
                    else {
                        chars.forEach(char => {
                            const charSpan = document.createElement('span');
                            charSpan.classList.add('split-text-char');
                            charSpan.style.display = 'inherit';
                            charSpan.style.textIndent = '0';
                            charSpan.innerHTML = char;
                            wordSpan.appendChild(charSpan);
                            this.chars.push(charSpan);
                        });
                    }
                    wordsArray.push(wordSpan);
                    this.words.push(wordSpan);
                });
                this.wordsArray.push(wordsArray);
                this.nodes.push(node);
            }
        }
    }
    initNewNodes() {
        this.nodes.forEach((node, index) => {
            this.wordsArray[index].forEach((word, idx) => {
                let maskSpan;
                if (this.options.mask) {
                    maskSpan = document.createElement('span');
                    maskSpan.classList.add('split-text-mask');
                    maskSpan.style.display = 'inline-block';
                    maskSpan.style.overflow = 'hidden';
                    maskSpan.style.textIndent = '0';
                    maskSpan.style.verticalAlign = 'top';
                    maskSpan.appendChild(word);
                    node.parentNode.insertBefore(maskSpan, node);
                }
                else {
                    node.parentNode.insertBefore(word, node);
                }
                const spaceSpan = document.createElement('span');
                spaceSpan.classList.add('split-text-space');
                spaceSpan.style.display = 'inline';
                spaceSpan.innerHTML = ' ';
                if (this.options.mask) {
                    node.parentNode.insertBefore(spaceSpan, maskSpan.nextSibling);
                }
                else {
                    node.parentNode.insertBefore(spaceSpan, word.nextSibling);
                }
                if (idx === this.wordsArray[index].length - 1) {
                    node.remove();
                }
            });
        });
    }
    splitNodesIntoWords(word) {
        const words = word.textContent.split(' ');
        if (words[0] === '') {
            words.splice(0, 1);
        }
        if (words[words.length - 1] === '') {
            words.splice(words.length - 1, 1);
        }
        return words.map(item => item.split(''));
    }
    getLines(elements) {
        const lineElements = [];
        let line = [];
        let lineIndex = 0;
        elements.forEach((el, index) => {
            const firstElTop = elements[lineIndex].getBoundingClientRect().top;
            const lastElIndex = elements.length - 1;
            if (el.getBoundingClientRect().top === firstElTop) {
                line.push(el);
                if (index === lastElIndex) {
                    lineElements.push(line);
                }
            }
            else {
                lineElements.push(line);
                lineIndex = index;
                line = [];
                line.push(el);
            }
        });
        return lineElements;
    }
    updateOnResize() {
        fromEvent(window, 'resize')
            .subscribe(() => {
            this.setLines();
        });
    }
    setLines() {
        this.lineWords = this.getLines(this.words);
        if (!this.options.onlyWords) {
            this.lineChars = this.getLines(this.chars);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3BsaXQtbm9kZXMuanMiLCJzb3VyY2VSb290IjoiL1VzZXJzL3lhbi9EZXNrdG9wL25nLWd4LXNwbGl0LXRleHQtZGVtby9wcm9qZWN0cy9uZy1neC1zcGxpdC10ZXh0L3NyYy8iLCJzb3VyY2VzIjpbImxpYi91dGlscy9zcGxpdC1ub2Rlcy9zcGxpdC1ub2Rlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBR2pDLE1BQU0sT0FBTyxVQUFVO0lBRXJCLFlBQ1UsV0FBbUIsRUFDbkIsRUFBZSxFQUNmLE9BQWdCO1FBRmhCLGdCQUFXLEdBQVgsV0FBVyxDQUFRO1FBQ25CLE9BQUUsR0FBRixFQUFFLENBQWE7UUFDZixZQUFPLEdBQVAsT0FBTyxDQUFTO1FBSTFCLFVBQUssR0FBa0IsRUFBRSxDQUFDO1FBQzFCLFVBQUssR0FBa0IsRUFBRSxDQUFDO1FBQzFCLGNBQVMsR0FBa0IsRUFBRSxDQUFDO1FBQzlCLGNBQVMsR0FBa0IsRUFBRSxDQUFDO1FBRTlCLGVBQVUsR0FBb0IsRUFBRSxDQUFDO1FBQ2pDLFVBQUssR0FBRyxFQUFFLENBQUM7UUFFWCxjQUFTLEdBQUc7WUFDVixZQUFZLEVBQUUsQ0FBQztZQUNmLGNBQWMsRUFBRSxDQUFDO1lBQ2pCLFNBQVMsRUFBRSxDQUFDO1lBQ1osa0JBQWtCLEVBQUUsQ0FBQztZQUNyQixxQkFBcUIsRUFBRSxDQUFDO1lBQ3hCLFdBQVcsRUFBRSxDQUFDO1lBQ2QsMkJBQTJCLEVBQUUsQ0FBQztZQUM5QixZQUFZLEVBQUUsQ0FBQztZQUNmLGFBQWEsRUFBRSxDQUFDO1lBQ2hCLGtCQUFrQixFQUFFLEVBQUU7WUFDdEIsc0JBQXNCLEVBQUUsRUFBRTtZQUMxQixhQUFhLEVBQUUsRUFBRTtTQUNsQixDQUFDO0lBdkJGLENBQUM7SUF5QkQsY0FBYztRQUNaLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3pCLElB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bnQiOlsiaW1wb3J0IHsgZnJvbUV2ZW50IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBPcHRpb25zIH0gZnJvbSBcIi4uLy4uL21vZGVscy9vcHRpb25zXCI7XG5cbmV4cG9ydCBjbGFzcyBTcGxpdE5vZGVzIHtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHRleHRDb250ZW50OiBzdHJpbmcsXG4gICAgcHJpdmF0ZSBlbDogSFRNTEVsZW1lbnQsXG4gICAgcHJpdmF0ZSBvcHRpb25zOiBPcHRpb25zXG4gICkge1xuICB9XG5cbiAgd29yZHM6IEhUTUxFbGVtZW50W10gPSBbXTtcbiAgY2hhcnM6IEhUTUxFbGVtZW50W10gPSBbXTtcbiAgbGluZVdvcmRzOiBIVE1MRWxlbWVudFtdID0gW107XG4gIGxpbmVDaGFyczogSFRNTEVsZW1lbnRbXSA9IFtdO1xuXG4gIHdvcmRzQXJyYXk6IEhUTUxFbGVtZW50W11bXSA9IFtdO1xuICBub2RlcyA9IFtdO1xuXG4gIG5vZGVUeXBlcyA9IHtcbiAgICBFTEVNRU5UX05PREU6IDEsXG4gICAgQVRUUklCVVRFX05PREU6IDIsXG4gICAgVEVYVF9OT0RFOiAzLFxuICAgIENEQVRBX1NFQ1RJT05fTk9ERTogNCxcbiAgICBFTlRJVFlfUkVGRVJFTkNFX05PREU6IDUsXG4gICAgRU5USVRZX05PREU6IDYsXG4gICAgUFJPQ0VTU0lOR19JTlNUUlVDVElPTl9OT0RFOiA3LFxuICAgIENPTU1FTlRfTk9ERTogOCxcbiAgICBET0NVTUVOVF9OT0RFOiA5LFxuICAgIERPQ1VNRU5UX1RZUEVfTk9ERTogMTAsXG4gICAgRE9DVU1FTlRfRlJBR01FTlRfTk9ERTogMTEsXG4gICAgTk9UQVRJT05fTk9ERTogMTJcbiAgfTtcblxuICBpbml0U3BsaXROb2RlcygpIHtcbiAgICB0aGlzLnNwbGl0Tm9kZXModGhpcy5lbCk7XG4gICAgdGhpcy5pbml0TmV3Tm9kZXMoKTtcbiAgICB0aGlzLnNldExpbmVzKCk7XG4gICAgdGhpcy51cGRhdGVPblJlc2l6ZSgpO1xuICB9XG5cblxuICBzcGxpdE5vZGVzKGVsKSB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBlbC5jaGlsZE5vZGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBub2RlID0gZWwuY2hpbGROb2Rlc1tpXTtcbiAgICAgIGNvbnN0IHRhZyA9IFt0aGlzLm5vZGVUeXBlcy5FTEVNRU5UX05PREUsIHRoaXMubm9kZVR5cGVzLkRPQ1VNRU5UX05PREUsIHRoaXMubm9kZVR5cGVzLkRPQ1VNRU5UX0ZSQUdNRU5UX05PREVdLmluZGV4T2Yobm9kZS5ub2RlVHlwZSkgIT09IC0xO1xuICAgICAgY29uc3QgdGV4dCA9IFt0aGlzLm5vZGVUeXBlcy5URVhUX05PREUsIHRoaXMubm9kZVR5cGVzLkNEQVRBX1NFQ1RJT05fTk9ERV0uaW5kZXhPZihub2RlLm5vZGVUeXBlKSAhPT0gLTE7XG5cbiAgICAgIGlmICh0YWcpIHtcbiAgICAgICAgdGhpcy5zcGxpdE5vZGVzKG5vZGUpO1xuICAgICAgfSBlbHNlIGlmICh0ZXh0KSB7XG4gICAgICAgIGNvbnN0IHdvcmRzID0gdGhpcy5zcGxpdE5vZGVzSW50b1dvcmRzKG5vZGUpO1xuXG4gICAgICAgIGNvbnN0IHdvcmRzQXJyYXkgPSBbXTtcbiAgICAgICAgd29yZHMuZm9yRWFjaChjaGFycyA9PiB7XG4gICAgICAgICAgY29uc3Qgd29yZFNwYW4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyk7XG4gICAgICAgICAgd29yZFNwYW4uY2xhc3NMaXN0LmFkZCgnc3BsaXQtdGV4dC13b3JkJyk7XG4gICAgICAgICAgd29yZFNwYW4uc3R5bGUuZGlzcGxheSA9ICdpbmxpbmUtYmxvY2snO1xuICAgICAgICAgIHdvcmRTcGFuLnN0eWxlLnRleHRJbmRlbnQgPSAnMCc7XG5cbiAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLm9ubHlXb3Jkcykge1xuICAgICAgICAgICAgd29yZFNwYW4uaW5uZXJIVE1MID0gY2hhcnMuam9pbignJyk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNoYXJzLmZvckVhY2goY2hhciA9PiB7XG4gICAgICAgICAgICAgIGNvbnN0IGNoYXJTcGFuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpO1xuICAgICAgICAgICAgICBjaGFyU3Bhbi5jbGFzc0xpc3QuYWRkKCdzcGxpdC10ZXh0LWNoYXInKTtcbiAgICAgICAgICAgICAgY2hhclNwYW4uc3R5bGUuZGlzcGxheSA9ICdpbmhlcml0JztcbiAgICAgICAgICAgICAgY2hhclNwYW4uc3R5bGUudGV4dEluZGVudCA9ICcwJztcbiAgICAgICAgICAgICAgY2hhclNwYW4uaW5uZXJIVE1MID0gY2hhcjtcbiAgICAgICAgICAgICAgd29yZFNwYW4uYXBwZW5kQ2hpbGQoY2hhclNwYW4pO1xuICAgICAgICAgICAgICB0aGlzLmNoYXJzLnB1c2goY2hhclNwYW4pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgd29yZHNBcnJheS5wdXNoKHdvcmRTcGFuKTtcbiAgICAgICAgICB0aGlzLndvcmRzLnB1c2god29yZFNwYW4pO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLndvcmRzQXJyYXkucHVzaCh3b3Jkc0FycmF5KTtcbiAgICAgICAgdGhpcy5ub2Rlcy5wdXNoKG5vZGUpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGluaXROZXdOb2RlcygpIHtcbiAgICB0aGlzLm5vZGVzLmZvckVhY2goKG5vZGUsIGluZGV4KSA9PiB7XG4gICAgICB0aGlzLndvcmRzQXJyYXlbaW5kZXhdLmZvckVhY2goKHdvcmQsIGlkeCkgPT4ge1xuICAgICAgICBsZXQgbWFza1NwYW46IEhUTUxFbGVtZW50O1xuICAgICAgICBpZiAodGhpcy5vcHRpb25zLm1hc2spIHtcbiAgICAgICAgICBtYXNrU3BhbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTtcbiAgICAgICAgICBtYXNrU3Bhbi5jbGFzc0xpc3QuYWRkKCdzcGxpdC10ZXh0LW1hc2snKTtcbiAgICAgICAgICBtYXNrU3Bhbi5zdHlsZS5kaXNwbGF5ID0gJ2lubGluZS1ibG9jayc7XG4gICAgICAgICAgbWFza1NwYW4uc3R5bGUub3ZlcmZsb3cgPSAnaGlkZGVuJztcbiAgICAgICAgICBtYXNrU3Bhbi5zdHlsZS50ZXh0SW5kZW50ID0gJzAnO1xuICAgICAgICAgIG1hc2tTcGFuLnN0eWxlLnZlcnRpY2FsQWxpZ24gPSAndG9wJztcbiAgICAgICAgICBtYXNrU3Bhbi5hcHBlbmRDaGlsZCh3b3JkKVxuICAgICAgICAgIG5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobWFza1NwYW4sIG5vZGUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUod29yZCwgbm9kZSk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzcGFjZVNwYW4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyk7XG4gICAgICAgIHNwYWNlU3Bhbi5jbGFzc0xpc3QuYWRkKCdzcGxpdC10ZXh0LXNwYWNlJyk7XG4gICAgICAgIHNwYWNlU3Bhbi5zdHlsZS5kaXNwbGF5ID0gJ2lubGluZSc7XG4gICAgICAgIHNwYWNlU3Bhbi5pbm5lckhUTUwgPSAnICc7XG5cbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5tYXNrKSB7XG4gICAgICAgICAgbm9kZS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShzcGFjZVNwYW4sIG1hc2tTcGFuLm5leHRTaWJsaW5nKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBub2RlLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHNwYWNlU3Bhbiwgd29yZC5uZXh0U2libGluZyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoaWR4ID09PSB0aGlzLndvcmRzQXJyYXlbaW5kZXhdLmxlbmd0aCAtIDEpIHtcbiAgICAgICAgICBub2RlLnJlbW92ZSgpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIHNwbGl0Tm9kZXNJbnRvV29yZHMod29yZCkge1xuICAgIGNvbnN0IHdvcmRzID0gd29yZC50ZXh0Q29udGVudC5zcGxpdCgnICcpO1xuXG4gICAgaWYgKHdvcmRzWzBdID09PSAnJykge1xuICAgICAgd29yZHMuc3BsaWNlKDAsIDEpO1xuICAgIH1cblxuICAgIGlmICh3b3Jkc1t3b3Jkcy5sZW5ndGggLSAxXSA9PT0gJycpIHtcbiAgICAgIHdvcmRzLnNwbGljZSh3b3Jkcy5sZW5ndGggLSAxLCAxKTtcbiAgICB9XG5cbiAgICByZXR1cm4gd29yZHMubWFwKGl0ZW0gPT4gaXRlbS5zcGxpdCgnJykpO1xuICB9XG5cbiAgZ2V0TGluZXMoZWxlbWVudHMpIHtcbiAgICBjb25zdCBsaW5lRWxlbWVudHMgPSBbXTtcbiAgICBsZXQgbGluZSA9IFtdO1xuICAgIGxldCBsaW5lSW5kZXggPSAwO1xuXG4gICAgZWxlbWVudHMuZm9yRWFjaCgoZWwsIGluZGV4KSA9PiB7XG5cbiAgICAgIGNvbnN0IGZpcnN0RWxUb3AgPSBlbGVtZW50c1tsaW5lSW5kZXhdLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLnRvcDtcbiAgICAgIGNvbnN0IGxhc3RFbEluZGV4ID0gZWxlbWVudHMubGVuZ3RoIC0gMTtcblxuICAgICAgaWYgKGVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLnRvcCA9PT0gZmlyc3RFbFRvcCkge1xuICAgICAgICBsaW5lLnB1c2goZWwpO1xuICAgICAgICBpZiAoaW5kZXggPT09IGxhc3RFbEluZGV4KSB7XG4gICAgICAgICAgbGluZUVsZW1lbnRzLnB1c2gobGluZSk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxpbmVFbGVtZW50cy5wdXNoKGxpbmUpO1xuICAgICAgICBsaW5lSW5kZXggPSBpbmRleDtcbiAgICAgICAgbGluZSA9IFtdO1xuICAgICAgICBsaW5lLnB1c2goZWwpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGxpbmVFbGVtZW50cztcbiAgfVxuXG4gIHVwZGF0ZU9uUmVzaXplKCkge1xuICAgIGZyb21FdmVudDxVSUV2ZW50Pih3aW5kb3csICdyZXNpemUnKVxuICAgICAgLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgIHRoaXMuc2V0TGluZXMoKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgc2V0TGluZXMoKSB7XG4gICAgdGhpcy5saW5lV29yZHMgPSB0aGlzLmdldExpbmVzKHRoaXMud29yZHMpO1xuICAgIGlmICghdGhpcy5vcHRpb25zLm9ubHlXb3Jkcykge1xuICAgICAgdGhpcy5saW5lQ2hhcnMgPSB0aGlzLmdldExpbmVzKHRoaXMuY2hhcnMpO1xuICAgIH1cbiAgfVxufVxuIl19